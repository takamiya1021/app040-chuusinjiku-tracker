# Gmail データ収集方法の提案

**作成日**: 2025-10-19
**対象**: 中心軸トラッカー プロジェクト

---

## 目的
Gmailに保存されている500〜700通のメールを収集し、AI要約を経てアプリのコンテンツとして利用する。

---

## 提案する3つの方法

### 【推奨】方法1: MCP Gmail Server（最も効率的）

#### 概要
Model Context Protocol（MCP）を使用してGmailに直接アクセスし、Claude Code内でメール取得・要約を一貫して実行。

#### 利用可能なMCPサーバー
1. **mcp-gmail by jeremyjordan** (推奨)
   - Python SDK基盤
   - OAuth 2.0認証
   - Gmail APIラッパー
   - リポジトリ: https://github.com/jeremyjordan/mcp-gmail

2. **Gmail-MCP-Server by GongRzhe**
   - 自動認証サポート
   - 添付ファイル対応
   - リポジトリ: https://github.com/GongRzhe/Gmail-MCP-Server

#### 実装手順
1. **MCPサーバーのインストール**
   ```bash
   cd ~/.local/lib/mcp-servers/
   git clone https://github.com/jeremyjordan/mcp-gmail.git gmail
   cd gmail
   pip install -e .
   ```

2. **Google Cloud Platform設定**
   - プロジェクト作成
   - Gmail API有効化
   - OAuth 2.0クライアントID作成（デスクトップアプリ）
   - credentials.jsonダウンロード

3. **MCP設定ファイル更新**
   - Claude Code設定に追加
   - OAuth認証フロー実行

4. **データ収集**
   - MCPツールでGmail検索
   - 特定ラベル・日付範囲でフィルタリング
   - メール本文取得

5. **AI要約処理**
   - 取得したメールをClaude/Geminiで要約
   - カテゴリー自動分類
   - JSON形式で保存

#### メリット
- ✅ Claude Code内で完結（環境一貫性）
- ✅ OAuth認証で安全
- ✅ 自動化しやすい
- ✅ エラーハンドリングが容易
- ✅ 要約処理と統合可能

#### デメリット
- ⚠️ 初回OAuth設定が必要
- ⚠️ Google Cloud Platform設定の手間

#### 推定時間
- セットアップ: 1〜2時間
- データ収集: 30分〜1時間（API制限により）
- 要約処理: 2〜3時間（500記事想定）

---

### 方法2: Gmail API直接利用（Pythonスクリプト）

#### 概要
Pythonスクリプトを作成し、Gmail APIで直接メール取得。

#### 実装手順
1. **Google Cloud Platform設定**（方法1と同じ）
2. **Pythonスクリプト作成**
   ```python
   from google.oauth2.credentials import Credentials
   from googleapiclient.discovery import build

   # Gmail API認証
   # メール一覧取得
   # 本文抽出
   # JSON保存
   ```

3. **要約処理**
   - 別途AI APIを呼び出し

#### メリット
- ✅ シンプルな実装
- ✅ カスタマイズ性が高い

#### デメリット
- ❌ MCPとの統合が困難
- ❌ スクリプト管理が必要
- ❌ エラー処理を自分で実装

#### 推定時間
- セットアップ: 1〜2時間
- スクリプト作成: 2〜3時間
- データ収集: 30分〜1時間
- 要約処理: 2〜3時間

---

### 方法3: 手動エクスポート（最も簡単だが手間）

#### 概要
Gmail検索でメールを抽出し、mbox形式でエクスポート後、ローカルで解析。

#### 実装手順
1. **Gmail検索**
   - 特定ラベルや日付範囲で検索
   - 「すべて選択」で一括選択

2. **Google Takeoutでエクスポート**
   - Gmail → mbox形式
   - ダウンロード（数GB可能性あり）

3. **Pythonで解析**
   ```python
   import mailbox

   # mboxファイル読み込み
   # メール本文抽出
   # JSON化
   ```

4. **要約処理**
   - AI APIで要約

#### メリット
- ✅ APIキー不要（Takeout利用）
- ✅ 技術的難易度が低い

#### デメリット
- ❌ 完全に手動作業
- ❌ エクスポートに時間がかかる
- ❌ 大容量ファイルの扱いが面倒
- ❌ 自動化不可

#### 推定時間
- エクスポート: 1〜2時間（待機時間含む）
- 解析スクリプト作成: 1〜2時間
- データ抽出: 30分
- 要約処理: 2〜3時間

---

## 比較表

| 項目 | MCP Gmail (推奨) | Gmail API直接 | 手動エクスポート |
|------|-----------------|--------------|----------------|
| **難易度** | 中 | 中〜高 | 低〜中 |
| **所要時間** | 4〜6時間 | 6〜9時間 | 5〜8時間 |
| **自動化** | ◎ | ○ | × |
| **統合性** | ◎ | △ | × |
| **保守性** | ◎ | ○ | △ |
| **セキュリティ** | ◎ (OAuth) | ◎ (OAuth) | ○ |

---

## 推奨方法の詳細フロー

### MCP Gmail Serverを使った実装フロー

#### Phase 1: 環境構築（1〜2時間）
1. Google Cloud Platform設定
   - プロジェクト作成: "chuusinjiku-tracker"
   - Gmail API有効化
   - OAuth 2.0クライアントID作成
   - credentials.json取得

2. MCP Gmail Server インストール
   ```bash
   cd ~/.local/lib/mcp-servers/
   git clone https://github.com/jeremyjordan/mcp-gmail.git gmail
   cd gmail
   python -m venv venv
   source venv/bin/activate
   pip install -e .
   ```

3. Claude Code設定更新
   - MCP設定ファイルにgmailサーバー追加
   - OAuth認証実行

#### Phase 2: データ収集（30分〜1時間）
1. Gmail検索条件（確定）
   - **ラベル名**: `ヒロのリアルタイムメルマガ（有料年会費プログラム）`
   - **日付範囲**: `2023/01/01〜現在`
   - **Gmail検索クエリ**: `label:"ヒロのリアルタイムメルマガ（有料年会費プログラム）" after:2023/01/01`

2. MCPツールでメール取得
   ```
   # Claude Code内で実行
   - search_emails: 上記クエリでメール一覧取得
   - get_message: 各メールの本文取得（HTML/テキスト両対応）
   - 結果をJSON配列に格納
   ```

3. 中間データ保存
   - `data/raw_emails.json` として保存

#### Phase 3: データ処理（2バージョン作成）（3〜4時間）

**重要**: プライベート版とパブリック版の2つを作成

1. **Phase 3A: プライベート版作成（30分〜1時間）**
   - **処理内容**: 軽微な整形のみ
   - **AI使用**: Gemini 2.5 Flash（カテゴリー・タイトル生成のみ）
   - **本文**: 元メール本文をそのまま保持

   プライベート版プロンプト:
   ```
   以下のメール本文を分析し、タイトルとカテゴリーのみ提案してください。
   本文はそのまま使用するため、要約は不要です。

   【タスク】
   - タイトル: 30文字以内で内容を表すタイトル
   - カテゴリー: 1つ選択（自己受容、目標設定、習慣形成、マインドセット、人間関係、感謝、行動力など）

   【出力形式】
   タイトル: [タイトル]
   カテゴリー: [カテゴリー名]

   [メール本文]
   ```

   - **保存先**: `data/articles-private.json`

2. **Phase 3B: パブリック版作成（2〜3時間）**
   - **処理内容**: 完全要約・再構成
   - **AI使用**: Gemini 2.5 Flash（要約処理）
   - **本文**: 著作権対策済み要約版

   パブリック版プロンプト（確定版・著作権対策含む）
   ```
   以下のメール本文を、メンタルを整える読み物として要約してください。

   【要約条件】
   - 文字数: 1000〜3000文字（元の長さに応じて調整）
   - 心に響くメッセージ・本質的な内容を保持
   - 読みやすく、自然な文章構成
   - カテゴリーを1つ提案（例: 自己受容、目標設定、習慣形成、マインドセット、人間関係、感謝、行動力など）

   【著作権対策（必須）】
   - 元の表現・言い回しをそのまま使用しない
   - 固有の言い回しや独自の表現を避ける
   - 伝えたい本質的なメッセージ・教訓を抽出し、一般的でわかりやすい表現に再構成する
   - 引用ではなく、内容を理解した上での「再構成」として作成する
   - オリジナルとは異なる文章構成・言い回しを使用する

   【出力形式】
   タイトル: [30文字以内の魅力的なタイトル]
   カテゴリー: [カテゴリー名]
   本文: [要約された本文]

   [メール本文]
   ```

   - **保存先**: `data/articles-public.json`

3. バッチ処理実装（共通）
   - 50件ずつ処理（API制限対策）
   - エラーハンドリング
   - 進捗表示
   - プライベート版 → パブリック版の順で処理

4. 最終データ保存
   - プライベート版: `data/articles-private.json`
   - パブリック版: `data/articles-public.json`
   - 各記事にID、タイトル、カテゴリー、日付を付与（両バージョン共通構造）

#### Phase 4: データ検証（30分）
1. データ品質チェック（両バージョン）
   - 重複記事の確認
   - プライベート版: 元本文が保持されているか
   - パブリック版: 文字数チェック（1000〜3000文字範囲）
   - カテゴリー分布確認
   - 記事数の一致確認（両バージョンで同じ記事数）

2. 手動レビュー
   - プライベート版: ランダムサンプル5件確認（タイトル・カテゴリーの妥当性）
   - パブリック版: ランダムサンプル10件確認（要約品質・著作権対策）

---

## セキュリティ考慮事項

### OAuth トークン管理
- **保存場所**: `~/.local/lib/mcp-servers/gmail/token.json`
- **権限スコープ**: `gmail.readonly`（読み取り専用推奨）
- **更新**: 自動更新対応

### APIキー管理
- **Gmail API**: OAuth使用（APIキー不要）
- **要約AI**: 環境変数で管理
  ```bash
  export GEMINI_API_KEY="your-key-here"
  ```

### データ保護
- 生データ（raw_emails.json）は処理後削除検討
- 最終データ（articles.json）のみ保持
- 個人情報（メールアドレス等）は除外

---

## コスト見積もり

### Google Cloud Platform
- **Gmail API**: 無料（1日あたり10億クォータ、個人利用では十分）

### AI要約コスト（Gemini Flash想定）
- **入力**: 500記事 × 平均5,000文字 = 2,500,000文字
- **出力**: 500記事 × 平均2,000文字 = 1,000,000文字
- **推定コスト**: 約$1〜$3（Gemini Flash料金による）

### 総コスト
- **約$1〜$3**（非常に低コスト）

---

## 次のアクション

### 実装開始前の確認事項
1. ✅ Gmail内のメールラベル確認（どのラベルに該当メールがあるか）
2. ✅ 日付範囲の確定（正確な期間）
3. ✅ Google アカウントのアクセス許可確認
4. ✅ 要約に使用するAI選択（Gemini Flash or Claude）

### 推奨実装順序
1. **今すぐ**: MCP Gmail Serverセットアップ開始
2. **セットアップ完了後**: テストメール5件で動作確認
3. **動作確認後**: 全データ収集開始
4. **収集完了後**: 要約処理バッチ実行
5. **要約完了後**: 技術設計書作成・アプリ実装開始

---

## 質問・確認事項

### あおいさんからの回答 ✅
1. **Gmailのメールラベル**: `ヒロのリアルタイムメルマガ（有料年会費プログラム）`
2. **日付範囲**: 2023年1月1日〜現在（約2年10ヶ月分）
3. **カテゴリー**: 自動分類（AI要約時にカテゴリー提案）
4. **要約AI選択**: Gemini 2.5 Flash

---

**結論**: MCP Gmail Serverを使った方法1を強く推奨します。
理由: 効率性・統合性・保守性のバランスが最も優れているため。
